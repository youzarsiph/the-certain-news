{% load i18n %}

<section
  id="container"
  title="{% trans 'Breaking' %}"
  class="container mx-auto max-w-dvw px-4"
>
  <ol id="live-line" class="carousel w-full carousel-center">
    {% for article in articles %}
    <li class="carousel-item w-full grow">
      <a
        role="alert"
        class="alert-soft alert w-full alert-error"
        href="{% url 'ui:redirect' article.link.slug %}"
      >
        <div
          class="tooltip tooltip-right tooltip-error rtl:tooltip-left"
          data-tip="{% trans 'Breaking' %}"
        >
          <span class="btn btn-circle btn-xs btn-error lg:btn-sm">
            <span class="sr-only">{% trans 'Breaking' %}</span>
            <i data-lucide="alert-circle" class="size-4 lg:size-6"></i>
          </span>
        </div>

        <p>{{ article.title }}</p>
      </a>
    </li>
    {% endfor %}
  </ol>
</section>

<script>
  function insertLiveArticleAlert(article) {
    const carousel = document.getElementById('live-line');
    if (!carousel) return;

    const container = document.getElementById('container');
    container.classList.toggle('hidden')

    // Create a new li element for the article
    const li = document.createElement('li');
    li.classList = 'carousel-item w-full grow';

    li.innerHTML = `
      <a
        role="alert"
        href="${article.url}"
        class="alert-soft alert w-full alert-error"
      >
        <div
          class="tooltip tooltip-right tooltip-error rtl:tooltip-left"
          data-tip="{% trans 'Breaking' %}"
        >
          <span class="btn btn-circle btn-xs btn-error lg:btn-sm">
            <span class="sr-only">{% trans 'Breaking' %}</span>
            <i data-lucide="alert-circle" class="size-4 lg:size-6"></i>
          </span>
        </div>

        <p>${article.title}</p>
      </a>`;

    // Insert as first child
    carousel.insertBefore(li, carousel.firstChild);
    lucide.createIcons();
  }

  const ws = new WebSocket(;ws://; + window.location.host + ;/ws/live-feed/;);

  ws.onmessage = function (e) {
    const article = JSON.parse(e.data);
    insertLiveArticleAlert(article);
  };

  ws.onclose = function (e) {
    console.error('Chat socket closed unexpectedly');
  };
</script>
